{% extends "layout.html" %}
{% load static %}
{% block title %}{{ title }}{% endblock %}

{% block content %}

<h2 class="mb-4">{{ title }}</h2>
<div class="mb-3 text-end">
  <a href="{% url 'meals:statistics' %}?from=bulk" class="btn btn-secondary">
    üìä Th·ªëng k√™
  </a>
</div>
<form id="meal-form" method="POST">
  {% csrf_token %}
  {% if is_superadmin %}
    <div class="form-group mb-3">
      <label for="id_record_date">Ch·ªçn ng√†y:</label>
      <div class="input-group">
        <input
          type="date"
          id="id_record_date"
          name="record_date"
          class="form-control"
          value="{{ default_date }}"
          onkeydown="return false;"
        />
      </div>
    </div>
  {% endif %}
  <!-- Ch·ªçn L·ªõp -->
  <div class="form-group mb-3">
    <label for="id_class_choice">Ch·ªçn L·ªõp:</label>
    <select id="id_class_choice" class="form-control">
      <option value="">-- Ch·ªçn L·ªõp --</option>
      {% for cls in class_list %}
        <option value="{{ cls }}">{{ cls }}</option>
      {% endfor %}
    </select>
  </div>

  <!-- Ch·ªçn Lo·∫°i B·ªØa ƒÇn -->
  <div class="form-group mb-3">
    <label for="id_meal_type">Lo·∫°i B·ªØa ƒÇn:</label>
    <select id="id_meal_type" class="form-control">
      <option value="">-- Ch·ªçn B·ªØa ƒÇn --</option>
      <option value="B·ªØa s√°ng">B·ªØa s√°ng</option>
      <option value="B·ªØa tr∆∞a">B·ªØa tr∆∞a</option>
    </select>
  </div>

  <!-- Danh s√°ch h·ªçc sinh s·∫Ω load v√†o ƒë√¢y -->
  <div id="student-list" class="mb-3"></div>

  <button id="btn-save" class="btn btn-primary">L∆∞u D·ªØ Li·ªáu</button>
</form>

<script>
  const defaultDate = '{{ default_date }}';
  const isAdmin     = {{ is_superadmin|yesno:"true,false" }};
  function getSelectedDate() {
    return isAdmin
      ? document.getElementById('id_record_date').value
      : defaultDate;
  }
// Ch·∫°y sau khi to√†n b·ªô DOM v√† script trong layout ƒë√£ load xong (jQuery ƒë√£ s·∫µn s√†ng)
document.addEventListener('DOMContentLoaded', function() {
  // H√†m load d·ªØ li·ªáu h·ªçc sinh qua AJAX
  function loadMealData() {
    var className = document.getElementById('id_class_choice').value;
    var mealType  = document.getElementById('id_meal_type').value;
    if (!className || !mealType) {
      document.getElementById('student-list').innerHTML = '';
      return;
    }
    $.ajax({
      url: "{% url 'meals:ajax_load_mealdata' %}",
      data: {
        date:       getSelectedDate(),    // ‚Üê th√™m d√≤ng n√†y
        class_name: className,
        meal_type:  mealType
      },
      success: function(data) {
        var html = '<h5>Danh s√°ch H·ªçc Sinh</h5>';
        data.forEach(function(item) {
          html += `
            <div class="form-check d-flex align-items-center mb-2">
              <input class="form-check-input student-checkbox" type="checkbox"
                     id="student_${item.id}" name="student_ids[]" value="${item.id}" ${item.checked ? 'checked' : ''} />
              <label class="form-check-label me-2" for="student_${item.id}">${item.name}</label>
              <select class="form-select absence-dropdown" name="absence_${item.id}" style="max-width:150px;" ${item.checked ? 'disabled' : ''}>
                <option value="1" ${item.non_eat == 1 ? 'selected' : ''}>C√≥ ph√©p</option>
                <option value="2" ${item.non_eat == 2 ? 'selected' : ''}>Kh√¥ng ph√©p</option>
              </select>
              <div class="reason-group" style="margin-left:10px;">
              <input type="text" class="form-control reason-input" name="reason_${item.id}" placeholder="L√Ω do ngh·ªâ" value="${item.reason}" style="display: none; max-width:200px; margin-left:10px;" />
              </div>
            </div>
          `;
        });
        document.getElementById('student-list').innerHTML = html;
        document.querySelectorAll('#student-list .student-checkbox').forEach(function(cb) {
          var sid = cb.value;
          var inp = document.querySelector(`input[name="reason_${sid}"]`);
          inp.style.display = cb.checked ? 'none' : 'inline-block';
        });
      }
    });
  }

  // Khi student checkbox thay ƒë·ªïi: enable/disable dropdown v√† hi·ªÉn th·ªã l√Ω do n·∫øu untick
  document.getElementById('student-list').addEventListener('change', function(e) {
    if (e.target.matches('input.student-checkbox')) {
      var sid = e.target.value;
      var sel = document.querySelector("select[name='absence_" + sid + "']");
      var inp = document.querySelector("input[name='reason_" + sid + "']");
      if (e.target.checked) {
        sel.disabled = true;
        inp.style.display = 'none'; inp.value = '';
      } else {
        sel.disabled = false;
        inp.style.display = 'inline-block';
      }
    }
  });

  // Khi dropdown l√Ω do ngh·ªâ thay ƒë·ªïi: ƒëi·ªÅu ch·ªânh show/hide √¥ nh·∫≠p l√Ω do
  document.getElementById('student-list').addEventListener('change', function(e) {
    if (!e.target.matches("select[name^='absence_']")) return;
    var sid = e.target.name.split('_')[1];
    var inp = document.querySelector("input[name='reason_" + sid + "']");
    if (e.target.value != '0') {
      inp.style.display = 'inline-block';
    } else {
      inp.style.display = 'none'; inp.value = '';
    }
  document.addEventListener('DOMContentLoaded', function() {
    document.querySelectorAll('.student-checkbox').forEach(function(cb) {
      // l·∫•y lu√¥n c√°i input reason t∆∞∆°ng ·ª©ng
      const id = cb.value;
      const reasonInput = document.querySelector(`input[name="reason_${id}"]`);
      // kh·ªüi t·∫°o l·∫ßn ƒë·∫ßu
      reasonInput.style.display = cb.checked ? 'inline-block' : 'none';
      // g√°n s·ª± ki·ªán
      cb.addEventListener('change', function() {
        reasonInput.style.display = this.checked ? 'inline-block' : 'none';
      });
    });
  });
});

  // B·∫Øt s·ª± ki·ªán khi thay ƒë·ªïi Ch·ªçn L·ªõp ho·∫∑c Lo·∫°i B·ªØa
  document.getElementById('id_class_choice').addEventListener('change', loadMealData);
  document.getElementById('id_meal_type').addEventListener('change', loadMealData);
  const dateInput = document.getElementById('id_record_date');
  if (dateInput) {
    dateInput.addEventListener('change', loadMealData);
  }
  // Load l·∫ßn ƒë·∫ßu n·∫øu c√≥ gi√° tr·ªã
  loadMealData();

  // X·ª≠ l√Ω n√∫t L∆∞u
  document.getElementById('btn-save').addEventListener('click', function(e) {
    e.preventDefault();
    if (!confirm('B·∫°n c√≥ ch·∫Øc mu·ªën l∆∞u d·ªØ li·ªáu cho c√°c h·ªçc sinh?')) return;

    var studentIds  = [];
    var absenceData = {};
    var reasonData  = {};

    document.querySelectorAll('input.student-checkbox:checked').forEach(function(chk) {
      studentIds.push(chk.value);
    });
    document.querySelectorAll("select[name^='absence_']").forEach(function(sel) {
      var sid = sel.name.split('_')[1]; absenceData[sid] = sel.value;
    });
    document.querySelectorAll("input[name^='reason_']").forEach(function(inp) {
      var sid = inp.name.split('_')[1]; reasonData[sid] = inp.value;
    });

    $.ajax({
      url: "{% url 'meals:meal_bulk_save' %}",
      method: 'POST',
      data: {
        class_name:   document.getElementById('id_class_choice').value,
        meal_type:    document.getElementById('id_meal_type').value,
        student_ids:  studentIds,
        record_date:  getSelectedDate(),
        absence_data: JSON.stringify(absenceData),
        reason_data:  JSON.stringify(reasonData),
        csrfmiddlewaretoken: '{{ csrf_token }}'
      },
      success: function() { alert('ƒê√£ l∆∞u th√†nh c√¥ng!'); },
      error:   function() { alert('L∆∞u kh√¥ng th√†nh c√¥ng, vui l√≤ng th·ª≠ l·∫°i!'); }
    });
  });
});
</script>

{% endblock %}
