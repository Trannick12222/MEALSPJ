{% extends "layout.html" %}
{% load static %}
{% block title %}Chỉnh sửa Thanh toán Học sinh{% endblock %}

{% block content %}
<h2>Chỉnh sửa Thanh toán Học sinh</h2>

<!-- Hiển thị lỗi của form (nếu có) -->
{% if form.errors %}
<div class="alert alert-danger">
    <ul>
    {% for field in form %}
      {% for error in field.errors %}
         <li>{{ field.label }}: {{ error }}</li>
      {% endfor %}
    {% endfor %}
    {% for error in form.non_field_errors %}
         <li>{{ error }}</li>
    {% endfor %}
    </ul>
</div>
{% endif %}

<form method="post" id="payment-form">
    {% csrf_token %}

    <!-- Sử dụng widget của form cho lớp và học sinh -->
    <div class="form-group">
        {{ form.classroom.label_tag }}
        {{ form.classroom }}
    </div>
    <div class="form-group">
        {{ form.student.label_tag }}
        {{ form.student }}
    </div>

    <!-- Các trường khác -->
    <div class="form-group">
        {{ form.month.label_tag }}
        {{ form.month }}
    </div>
    <div class="form-group">
        {{ form.tuition_fee.label_tag }}
        {{ form.tuition_fee }}
    </div>
    <div class="form-group">
        {{ form.daily_meal_fee.label_tag }}
        {{ form.daily_meal_fee }}
    </div>
    <div class="form-group">
        {{ form.amount_paid.label_tag }}
        {{ form.amount_paid }}
    </div>

    <!-- Field ảo: Tiền tháng trước -->
    <div class="form-group">
        <label for="id_prev_month_balance">Công nợ</label>
        {{ form.prev_month_balance }}
    </div>
    <!-- Field ảo: Tiền tháng này -->
    <div class="form-group">
        <label for="id_current_month_payment">Tiền tháng này</label>
        {{ form.current_month_payment }}
    </div>

    <button type="submit" class="btn btn-primary">Lưu lại</button>
</form>

<!-- Khối hiển thị số bữa ăn đã ăn của học sinh -->
<div id="meal-counts" class="mt-4">
    <h4>Số bữa ăn đã ăn:</h4>
    <p>Bữa sáng: <span id="breakfast_count">{{ breakfast_count|default:"0" }}</span></p>
    <p>Bữa trưa: <span id="lunch_count">{{ lunch_count|default:"0" }}</span></p>
</div>

<!-- JavaScript load dữ liệu qua AJAX -->
<script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
<script>
$(document).ready(function(){
    // Khi dropdown Lớp thay đổi, load danh sách Học sinh qua AJAX
    $('#id_classroom').change(function(){
        var classroomID = $(this).val();
        if (classroomID) {
            $.ajax({
                url: "{% url 'ajax_load_students' %}",
                data: { 'classroom_id': classroomID },
                success: function(data) {
                    var options = '<option value="">-- Chọn Học sinh --</option>';
                    data.forEach(function(item){
                        options += '<option value="' + item.id + '">' + item.name + '</option>';
                    });
                    $('#id_student').html(options);
                }
            });
        } else {
            $('#id_student').html('<option value="">-- Chọn Học sinh --</option>');
        }
    });

    // Nếu không đang chỉnh sửa, attach AJAX load cho "student" và "month" để lấy số bữa ăn.
    var isEdit = {% if is_edit %}true{% else %}false{% endif %};
    if (!isEdit) {
        $('#id_student, #id_month').change(function(){
            var studentID = $('#id_student').val();
            var month = $('#id_month').val();
            if (studentID && month) {
                $.ajax({
                    url: "{% url 'ajax_load_payment_details' %}",
                    data: { 'student_id': studentID, 'month': month },
                    success: function(data) {
                        if (data.tuition_fee !== undefined) {
                            $('#id_tuition_fee').val(data.tuition_fee);
                        }
                        if (data.daily_meal_fee !== undefined) {
                            $('#id_daily_meal_fee').val(data.daily_meal_fee);
                        }
                        if (data.amount_paid !== undefined) {
                            $('#id_amount_paid').val(data.amount_paid);
                        }
                        if (data.current_month_payment !== undefined) {
                            $('#id_current_month_payment').val(data.current_month_payment);
                        }
                        if (data.prev_month_balance !== undefined) {
                            $('#id_prev_month_balance').val(data.prev_month_balance);
                        }
                        if (data.breakfast_count !== undefined) {
                            $('#breakfast_count').text(data.breakfast_count);
                        }
                        if (data.lunch_count !== undefined) {
                            $('#lunch_count').text(data.lunch_count);
                        }
                    }
                });
            }
        });
    }
});
</script>
{% endblock %}
